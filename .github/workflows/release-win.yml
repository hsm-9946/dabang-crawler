name: Release Windows EXE
on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build-win:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          # playwright íŒŒì´ì¬ ì‚¬ìš© ì‹œ ë¸Œë¼ìš°ì € ì„¤ì¹˜ (ìš©ëŸ‰â†‘ â†’ í•„ìš” ì‹œ ìœ ì§€)
          python -m playwright install chromium || echo "skip"

      - name: Build EXE (PyInstaller)
        shell: pwsh
        run: ./scripts/win/build-exe.ps1

      - name: Prepare artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null
          Copy-Item "dist/ë‹¤ë°©í¬ë¡¤ëŸ¬.exe" "artifacts/ë‹¤ë°©í¬ë¡¤ëŸ¬.exe"
          Copy-Item "dist/ë‹¤ë°©í¬ë¡¤ëŸ¬.exe" "artifacts/dabang-crawler-win-x64.exe"
          
          # íŒŒì¼ ì •ë³´ ì¶œë ¥
          $exePath = "artifacts/ë‹¤ë°©í¬ë¡¤ëŸ¬.exe"
          $fileSize = [math]::Round((Get-Item $exePath).Length / 1MB, 2)
          $fileHash = (Get-FileHash -Algorithm SHA256 $exePath).Hash
          Write-Host "ğŸ“„ ë¹Œë“œëœ íŒŒì¼: $exePath" -ForegroundColor Green
          Write-Host "ğŸ“ íŒŒì¼ í¬ê¸°: $fileSize MB" -ForegroundColor Green
          Write-Host "ğŸ” SHA256: $fileHash" -ForegroundColor Green

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: artifacts/*

  release:
    needs: build-win
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: ./artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/ë‹¤ë°©í¬ë¡¤ëŸ¬.exe
            artifacts/dabang-crawler-win-x64.exe
          body: |
            ## ğŸš€ ë‹¤ë°©í¬ë¡¤ëŸ¬ Windows ${{ github.ref_name }} ë¦´ë¦¬ì¦ˆ

            ### ğŸ“¦ ë‹¤ìš´ë¡œë“œ
            - **ë‹¤ë°©í¬ë¡¤ëŸ¬.exe** (í•œê¸€ëª…, ê¶Œì¥)
            - **dabang-crawler-win-x64.exe** (ì˜ë¬¸ëª…, ë°±ì—…)

            ### âœ¨ ì£¼ìš” ê¸°ëŠ¥
            - ë‹¤ë°© ë¶€ë™ì‚° ë§¤ë¬¼ ìë™ ìˆ˜ì§‘
            - Excel íŒŒì¼ë¡œ ë°ì´í„° ì €ì¥
            - GUI ëª¨ë“œ ì§€ì›
            - ì§€ì—­ë³„, ë§¤ë¬¼ íƒ€ì…ë³„ í•„í„°ë§
            - **ê°œì„ ëœ CSS ì„ íƒìë¡œ ì •í™•í•œ ë°ì´í„° íŒŒì‹±**
            - **ì¤‘ë³µ ì œê±° ë¹„í™œì„±í™” (ëª¨ë“  ë°ì´í„° ìˆ˜ì§‘)**

            ### ğŸ”§ ì„¤ì¹˜ ë°©ë²•
            1. **ë‹¤ë°©í¬ë¡¤ëŸ¬.exe** ë‹¤ìš´ë¡œë“œ
            2. ì••ì¶• í•´ì œ (ZIP ë‚´ ë”ë¸”í´ë¦­ ì‹¤í–‰ ê¸ˆì§€)
            3. Windows ì°¨ë‹¨ í•´ì œ: `Unblock-File -Path "ë‹¤ë°©í¬ë¡¤ëŸ¬.exe"`
            4. ë”ë¸”í´ë¦­ìœ¼ë¡œ ì‹¤í–‰

            ### ğŸ“‹ ì§€ì›í•˜ëŠ” ë§¤ë¬¼ íƒ€ì…
            - ì›ë£¸, íˆ¬ë£¸, ì•„íŒŒíŠ¸, ì£¼íƒ/ë¹Œë¼, ì˜¤í”¼ìŠ¤í…”

            ### ğŸ”§ ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­
            - Windows 10/11 (64ë¹„íŠ¸)
            - ì¸í„°ë„· ì—°ê²°
            - ìµœì†Œ 4GB RAM

            ### ğŸ›¡ï¸ ë³´ì•ˆ ì •ë³´
            - UPX ì••ì¶• ë¹„í™œì„±í™”ë¡œ ë°”ì´ëŸ¬ìŠ¤ ë°±ì‹  ì˜¤íƒ ë°©ì§€
            - SHA256 í•´ì‹œë¡œ íŒŒì¼ ë¬´ê²°ì„± ê²€ì¦
            - ì™„ì „í•œ ì†ŒìŠ¤ ì½”ë“œ ê³µê°œ (GitHub)

            ### ğŸ“„ ë¼ì´ì„ ìŠ¤
            ì´ ì†Œí”„íŠ¸ì›¨ì–´ëŠ” êµìœ¡ ë° ê°œì¸ ì‚¬ìš© ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.
            ìƒì—…ì  ì‚¬ìš© ì‹œ ë‹¤ë°©ì˜ ì´ìš©ì•½ê´€ì„ í™•ì¸í•˜ì„¸ìš”.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
